name: Notify Slack on Re-Requested Review

on:
  pull_request:
    types: [opened, ready_for_review, review_requested, closed, reopened]
    branches:
      - "**"

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack Notification with Mentions
        run: |
          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_ACTION="${{ github.event.action }}"  # PR ìƒíƒœ(opened, review_requested)
          PR_IS_DRAFT=${{ github.event.pull_request.draft }}

          # Draft PRì¼ ê²½ìš° ì•Œë¦¼ ìŠ¤í‚µ
          if [ "$PR_ACTION" == "opened" ] && [ "$PR_IS_DRAFT" == "true" ]; then
          echo "Draft PRì…ë‹ˆë‹¤. Slack ì•Œë¦¼ì„ ìƒëµí•©ë‹ˆë‹¤."
          exit 0  # ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ
          fi

          # PR ì‘ì„±ìì™€ ë¦¬ë·°ì–´ì˜ GitHub ë¡œê·¸ì¸ ì •ë³´
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          REQUESTED_REVIEWER="${{ github.event.requested_reviewer.login }}"

          # GitHub ì‚¬ìš©ìëª…ê³¼ Slack ID ë§¤í•‘
          declare -A GITHUB_TO_SLACK          
          GITHUB_TO_SLACK["yes2489"]="U092CL145CK"
          GITHUB_TO_SLACK["mingQ28"]="U0925H4NAEB"
          GITHUB_TO_SLACK["hyojeongbae"]="U092YBUK62J"
          GITHUB_TO_SLACK["CHICHIT"]="U093HSNER3J"
          GITHUB_TO_SLACK["yangyanghyunjung"]="U092J5GKMDK"
          GITHUB_TO_SLACK["JBL28"]="U092L1230LU"

          # ì‘ì„±ìì™€ ë¦¬ë·°ì–´ì˜ Slack ID ê°€ì ¸ì˜¤ê¸°
          # ì‘ì„±ì(PR_AUTHOR)ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ì²˜ë¦¬
          if [ -z "$PR_AUTHOR" ]; then
          SLACK_AUTHOR_ID="ì‘ì„±ì ì •ë³´ ì—†ìŒ"  # ì‘ì„±ì ì •ë³´ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€
          else
          SLACK_AUTHOR_ID=${GITHUB_TO_SLACK[$PR_AUTHOR]}
          fi

          # ë¦¬ë·°ì–´(REQUESTED_REVIEWER)ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ì²˜ë¦¬
          if [ -z "$REQUESTED_REVIEWER" ]; then
          SLACK_REVIEWER_ID="ë¦¬ë·°ì–´ ì •ë³´ ì—†ìŒ"  # ë¦¬ë·°ì–´ ì •ë³´ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€
          else
          SLACK_REVIEWER_ID=${GITHUB_TO_SLACK[$REQUESTED_REVIEWER]}
          fi

          # PR ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€ êµ¬ë¶„
          if [ "$PR_ACTION" == "opened" ]; then
            PR_STATUS="ğŸ¦ *ìƒˆ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!*"

            # ëª¨ë“  ì‚¬ìš©ì ë©˜ì…˜ ìƒì„±
            ALL_MENTIONS=""
            for USER_ID in "${GITHUB_TO_SLACK[@]}"; do
              ALL_MENTIONS+="<@$USER_ID> "
            done
          elif [ "$PR_ACTION" == "ready_for_review" ]; then
            PR_STATUS="ğŸ¦ *ë¦¬ë·°ë¥¼ ë°›ì„ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!*"

            # ëª¨ë“  ì‚¬ìš©ì ë©˜ì…˜ ìƒì„±
            ALL_MENTIONS=""
            for USER_ID in "${GITHUB_TO_SLACK[@]}"; do
              ALL_MENTIONS+="<@$USER_ID> "
            done
          elif [ "$PR_ACTION" == "review_requested" ]; then
            PR_STATUS="ğŸ¸ *ë¦¬ë·° ì¬ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤!*"
            ALL_MENTIONS="<@$SLACK_REVIEWER_ID>"
          elif [ "$PR_ACTION" == "closed" ]; then
            if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
              PR_STATUS="ğŸ¦âœ… *PR Merged*"
              ALL_MENTIONS=""
            else
              PR_STATUS="ğŸ¦âŒ *PR Closed*"
              ALL_MENTIONS=""
            fi
          elif [ "$PR_ACTION" == "reopened" ]; then
            PR_STATUS="ğŸ¦ *PRì´ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤!*"
            # PRì´ ë‹¤ì‹œ ì—´ë¦´ ë•Œë„ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            ALL_MENTIONS=""
            for USER_ID in "${GITHUB_TO_SLACK[@]}"; do
            ALL_MENTIONS+="<@$USER_ID> "
            done
          else
            PR_STATUS="ğŸ¦ *PR ì—…ë°ì´íŠ¸ ì•Œë¦¼*"
            ALL_MENTIONS=""
          fi

          # Slack Webhook í˜¸ì¶œ
          curl -X POST \
               -H 'Content-type: application/json' \
               --data '{
                 "text": "'"${PR_STATUS}"'\n*PR ì œëª©:* '"${PR_TITLE}"' (#'"${PR_NUMBER}"')\n*ì‘ì„±ì:* <@'"${SLACK_AUTHOR_ID}"'>\n*ë¦¬ë·°ì–´:* '"${ALL_MENTIONS}"'\n*ë§í¬:* '"${PR_URL}"'"
               }' \
               ${{ secrets.SLACK_WEBHOOK_URL}}
